<html>
  <head>
    <title>Cellular Automation</title>
    <script>

      //Constants:
      var neighborhoodPatterns = {moore:0, vonNeumann:1}
      var neighborhoodCalcs = {sum:0, average:1, min:2, max:3}

      var ruleConwaysGameOfLife = {
        name:"Conway's Game of Life",
        minCellValue:0,
        maxCellValue:1,
        neighborPattern:neighborhoodPatterns.moore,
        neighborhoodSize:1,
        neighborhoodCalculation:neighborhoodCalcs.sum,
        state:{0:{3:1, def:0}, 1:{2:1, 3:1, def:0}, def:0}:,
        defaultCell:0,
      };

      var currentRule = ruleConwaysGameOfLife;


      //Variables:
      var fpsCap = 10;
      var gridSize = {width:10, height:10};
      var cellSize = 10;

      var grid;
      var temoGrid;
      var updateGrid;

      var mouseDown = false;
      var firstPaint = 1;
      var secondPaint = 0;
      var currentPaint = firstPaint;


      //References:
      var canvas;
      var context;


      //Calculation Functions:

      function createArray(length) {
        var arr = new Array(length || 0),
            i = length;

        if (arguments.length > 1) {
          var args = Array.prototype.slice.call(arguments, 1);
          while(i--) arr[length-1 - i] = createArray.apply(this, args);
        }

        return arr;
      }

      function nextStep(){
        step++;

        for(var i=0;i<gridSize.width;i++){
          for(var j=0;j<gridSize.height;j++){
            var n = neighbourValue(i, j);
            tempGrid[i][j] = state[grid[i][j]] ? (state[grid[i][j]][n] ? (state[grid[i][j]][n]) : state[grid[i][j]].def ) : state.def ;
          }
        }

        for(var i=0;i<gridSize.width;i++){
          for(var j=0;j<gridSize.height;j++){
            updateGrid[i][j] = (grid[i][j] != tempGrid[i][j]);
            grid[i][j] = tempGrid[i][j];
            tempGrid[i][j] = currentRule.defaultCell;
          }
        }

        redraw();
      }
      
      
      function neighbourValue(){
        var n = 0;
        if(currentRule.neighborhoodCalculation == ne){
          
        }
        return n;
      }


      function neighbors(x, y, r, func){
        if(currentRule.neighborPattern == neighborhoodPatterns.moore){
          for(var i = x-r; i <= x+r; i ++){
            for(var j = y-r; i <= y+r; j++){
              if(i!=x && j!=y){
                func(i, j);
              }
            }
          }
        }else if(currentRule.neighborPattern == neighborhoodPatterns.vonNeumann){
          for(var i = -r; i <= r; i++){
            var ri = r - Math::abs(i);
            for(var j = -ri; j <= ri; j++){
              func(i, j);
            }
          }
        }else{
          alert("Neighborhood Pattern not recognised : ", currentRule.neighborPattern);
        }
      }

      function getCellWithSafty(x, y){
        if(x>=0 && y>=0 && x<gridSize.width && y<gridSize.height){
          return grid[x][y];
        }
        return defaultCell;
      }



      //Rendering Functions:

      function setCanvasSize(){
        gridSize = {width:Math.floor((canvas.width-1)/cellSize), height:Math.floor((canvas.height-1)/cellSize)};
      }

      function redraw(){

      }




      //Intreraction Functions:

      function initalize(){
        window.addEventListener("keypress", onKeyPress, false);
        window.addEventListener("resize", onResizeWindow, false);

        canvas.onmousedown = onDownCanvas;
        canvas.onmouseup = onUpCanvas;
        canvas.onmousemove = onMoveCanvas;

        initCanvas();
      }

      function initCanvas(){
        canvas = document.getElementById("canvasMain");
        context = canvas.getContext('2d');

        canvas.width  = window.innerWidth - 16;
        canvas.height = window.innerHeight - 16;

        setGridSize();

        grid = createArray(gridSize.width,gridSize.height);
        tempGrid = createArray(gridSize.width,gridSize.height);
        updateGrid = createArray(gridSize.width,gridSize.height);
      }



      function onDownCanvas(event){
        mouseDown = true;
        var mousePosition = getMousePosition(event);
        var x = Math.floor((mousePosition.x+window.scrollX)/cellSize);
        var y = Math.floor((mousePosition.y+window.scrollY)/cellSize);
        if(x>=0 && y>=0 && x<gridSize.width && y<gridSize.height){
          updateGrid[x][y] = true;
          currentPaint = grid[x][y] == firstPaint ? secondPaint : firstPaint;
          grid[x][y] = currentPaint;
        }
        redraw();
      }

      function onUpCanvas(event){
        mouseDown = false;
      }

      function onMoveCanvas(event){
        event.preventDefault();
        if(mouseDown){
          var mousePosition = getMousePosition(event);
          var x = Math.floor((mousePosition.x+window.scrollX)/cellSize);
          var y = Math.floor((mousePosition.y+window.scrollY)/cellSize);
          if(x>=0 && y>=0 && x<gridSize.width && y<gridSize.height){
            updateGrid[x][y] = true;
            grid[x][y] = currentPaint;
          }

          redraw();
        }
      }

      function onKeyPress(){

      }

      function onResizeWindow(){

      }



    </script>
  </head>
  <body>

    <canvas id="canvasMain">
      Canvas not supported, upgrade your browser dude.
    </canvas>

  </body>
</html>